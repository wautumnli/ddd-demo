# 什么是模型

模型是对领域的抽象和模拟，建模是针对特定问题建立领域的合理模型。

同样的事物在面对不同的业务不同领域时，模型是不一样的。

如图是商品在超市与电商中模型是不一样的。

![image-20220218170041415](typora/image-20220218170041415.png)

# 软件系统复杂性的来源

模型是对领域的抽象，建模是针对特定问题建立领域的合理模型。

复杂性来源于业务本身的复杂性和设计引入的额外复杂性

## 业务复杂导致模型复杂

如图是人民币在满足财务，印钞和防伪时模型会越来越复杂。

![image-20220218170409565](typora/image-20220218170409565.png)

## 技术实现引入额外复杂性

![image-20220218175158772](typora/image-20220218175158772.png)

# DDD核心思想

## 模型分解

![image-20220218174950474](typora/image-20220218174950474.png)

领域划分是面向问题空间，限界上下文是面向方案空间的。

## 模型驱动设计

![image-20220218175527098](typora/image-20220218175527098.png)

# 面向对象和敏捷与DDD的区别与联系

## DDD与面向对象

![image-20220218180039215](typora/image-20220218180039215.png)

## DDD与面向对象OOAD

![image-20220218180215828](typora/image-20220218180215828.png)

## DDD与敏捷

![image-20220218180650355](typora/image-20220218180650355.png)

敏捷开发：把一个大的目标分解成多个小目标，分阶段完成，每个阶段都有分析和设计过程。

![image-20220218180942734](typora/image-20220218180942734.png)



# DDD的过去，现状和未来

## DDD诞生

![image-20220218181143175](typora/image-20220218181143175.png)

2003年Eric大佬发布类领域驱动模型设计这本书，预示着领域模型的开始。

## DDD的发展

![image-20220218181241975](typora/image-20220218181241975.png)

# 建模和设计整体思路

## 整体流程



![image-20220214151625359](typora/image-20220214151625359.png)

## 用户故事

![image-20220218182411152](typora/image-20220218182411152.png)

## 通用语言

![image-20220218182638506](typora/image-20220218182638506.png)

![image-20220218182822854](typora/image-20220218182822854.png)

## 战略设计

![image-20220218182840997](typora/image-20220218182840997.png)

![image-20220218182934308](typora/image-20220218182934308.png)

## 战术设计

![image-20220214151356603](typora/image-20220214151356603.png)

## 常用的建模方法

![image-20220218183049920](typora/image-20220218183049920.png)

# 领域故事分析

使用Domain-story-modeler

举例：售卖机扫码支付购物的领域故事分析

![image-20220214153816006](typora/image-20220214153816006.png)

# 领域划分

## 什么是领域划分？

**领域划分**是以**分离关注点**为原则对问题空间的划分。

子域是领域中某个方面的问题和解决它所涉及的一切

![image-20220218183813609](typora/image-20220218183813609.png)

初步划分后

![image-20220218183828145](typora/image-20220218183828145.png)

# 关注点分离

# 领域划分和子域

# 防腐层

## 防腐层的构建

# 传统方式的问题

- 领域模型被省略，变成贫血模型

- 容易演变成基于数据的设计，一切从表结构开始

- 领域模型与技术实现混杂，易被技术实现绑架

# DDD传统四层架构

- 接口层 interface，外部通信，接口访问

- 应用层 application，事物控制，事件订阅，资源库读写

- 领域层 domain，核心，领域模型，设计，工厂

- 基础设施层 infrastructure，通用框架，工具

![image-20220214164728407](typora/image-20220214164728407.png)

# 依赖倒置和洋葱六边形架构

## 模型图

![image-20220214164803664](typora/image-20220214164803664.png)

## 上下文代码架构层次

![image-20220214175457697](typora/image-20220214175457697.png)

# 实体和值对象

## 定义

需要以ID来跟踪状态变化的对象为实体，否则为值对象

标识符相等的为实体，属性相等的为值对象

## 为什么要区分实体和值对象

- 值对象往往更轻量级
- 值对象不用跟踪变化
- 实体和值对象在领域中扮演的角色不一样

## 分辨实体和值对象

- 是否只读
- 生命周期是否跨越活动

# 资源库

## 什么是资源库

![image-20220221095427279](typora/image-20220221095427279.png)

## 资源库的意义

![image-20220221095800583](typora/image-20220221095800583.png)

# 领域事件为什么这么重要？

- 领域事件驱动建模
- 领域事件和很多重要思想相关

# 事件命名和基本属性

## 命名方法

名词 + 动词过去式

## 事件id

## 事件发生事件

# 发布和订阅方式

## 外部系统

- API定向通知
- API定时拉取
- 消息队列

## 内部系统

- 观察者模式
- 数据库流水
- 消息队列

# 事件存储

## 使用中间件存储

- 冗余机制
- 做好备份

## 基于数据库

- mongodb
- postgresql
- mysql

最好是分布式，做好时间分区

# 事件处理要求

## 顺序性

- 聚合ID
- 存储分片
- 消费分组

## 幂等性

用幂等性代替分布式事务，状态判断和去重

# 领域事件和大数据分析

![image-20220215110615842](typora/image-20220215110615842.png)

# 什么是事件风暴

- 一种**协作式**的对复杂业务领域进行探索的讨论形式
- 一种**灵活易调整**的**轻量级**的适用于DDD的建模方法

# 事件风暴的应用场景

- 评估已有业务线的健康度并发现其优点
- 探索一个新业务的模型可行性
- 设想为各个参与方能带来最大利益的新服务
- 设计整洁的可维护的软件以支持快速推进的业务

# 事件风暴核心词汇

- 领域事件
- 聚合
- 决策命令
- 角色
- 读模型
- 策略

# DDD与微服务

## 微服务的好处

- 技术异构性
- 容错性
- 灵活扩展
- 简化部署
- 与组织架构匹配
- 可组合性
- 方便替代和升级

# 项目代码结构

## repository

repository在application层定义接口，在port层实现。一个repository可以是多个到加载一个领域实体。

## cmdService

拿的是对象，存的也是对象

## po

一个po对应一张表

## dto

返回前端的对象，可以是个"宽对象"

## cmd

前端查询操作条件

## condition

查询结果，可能是多个表联合出来的长表

## 代码结构

```
├── demo-api ---------------------------------------------------------------【rpc接口】
├── demo-application -------------------------------------------------------【应用层】
│   └── application
│       └── social
│           ├── command
│           │   ├── IEntityMetaCmdService.java -----------------------------【cmd接口】
│           │   ├── IPersonCmdService.java
│           │   ├── cmd ----------------------------------------------------【cmd实体】
│           │   │   ├── EntityMetaCmd.java
│           │   │   └── PersonCmd.java
│           │   ├── impl ---------------------------------------------------【cmd实现】
│           │   │   ├── EntityMetaCmdServiceImpl.java
│           │   │   └── PersonCmdServiceImpl.java
│           │   ├── repository ---------------------------------------------【仓库接口】
│           │   │   ├── IEntityMetaRepository.java
│           │   │   └── IPersonRepository.java
│           │   └── tx -----------------------------------------------------【事务接口】
│           │       ├── IEntityMetaTransactionService.java
│           │       ├── IPersonTransactionService.java
│           │       └── impl -----------------------------------------------【事务实现】
│           │           ├── EntityMetaTransactionServiceImpl.java
│           │           └── PersonTransactionServiceImpl.java
│           ├── dto --------------------------------------------------------【DTO】
│           └── query ------------------------------------------------------【查询接口】
│               ├── IEntityMetaQueryService.java
│               ├── IPersonQueryService.java
│               └── condition ----------------------------------------------【查询实体】
│                   ├── EntityMetaCondition.java
│                   └── PersonCondition.java
├── demo-core
│   └── core
│       ├── constant -------------------------------------------------------【常量】
│       │   └── Constant.java
│       └── dto ------------------------------------------------------------【共用dto】
│           └── Result.java
├── demo-domain ------------------------------------------------------------【领域层】
│   └── domain
│       └── social
│           └── entity
│               ├── EntityMeta.java
│               └── Person.java
├── demo-port
│   └── port
│       ├── demand
│       │   └── persistent
│       │       ├── common
│       │       │   └── config ---------------------------------------------【共用配置类】
│       │       │       ├── CustomMetaObjectHandler.java
│       │       │       └── MybatisPlusConfig.java
│       │       └── social
│       │           ├── dao ------------------------------------------------【初始化实现】
│       │           ├── mapper ---------------------------------------------【mapper转换】
│       │           ├── po -------------------------------------------------【持久化实体】
│       │           ├── query ----------------------------------------------【查询实现】
│       │           └── repository -----------------------------------------【仓库实现】
│       └── supply
│           └── web
│               ├── controller ---------------------------------------------【controller】
│               └── interceptor --------------------------------------------【拦截器】
│                   └── GlobalExceptionHandler.java
├── demo-spi ---------------------------------------------------------------【spi模块】
├── demo-start -------------------------------------------------------------【start模块】
│   └── DemoApplication.java -----------------------------------------------【启动类】
```

